<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
    <title>Email per transaction</title>
    <link rel="stylesheet" type="text/css" href="../css/common.css" />
    <link rel="stylesheet" type="text/css" href="../css/screen.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="../css/_print.css" media="print" />
    <link rel="stylesheet" type="text/css" href="../css/prettify.css" media="screen" />

  </head>
  <body onload="prettyPrint()">
    <script type="text/javascript">prefix='../';</script>
    <script type="text/javascript" src="../js/prettify.js"></script>
    <script src="../templates/header.js" type="text/javascript"></script>
    <div id="left">
      <noscript>Please turn on Javascript to view this menu</noscript>
      <script src="../templates/left.js" type="text/javascript"></script>
    </div>
    <div id="content">
      
      <h2>Triggering an email containing the isoloated logs of selected
      transactions</h2>
      
      <p>Let Dave and Carol be software QA engineers working at a
      company called Fooware.com. As you might have guessed,
      Fooware.com sells foos. Yes, foos... Let <em>Buscrit</em> be a
      business critical backend system running at Fooware.com. Buscrit
      is called by a number of applications to make business-critical
      transactions of various types.
      </p>

      <p>We would like to allow Carol to access the logging data
      generated by Buscrit as conveniently as possible. We could
      assume that Carol has access the log files directly on the
      server where Buscrit runs. However, let us assume that accessing
      the log files is somehow impractical because one or ore more of
      the following conditions holds true:
      </p>

      <ol>
        <li>Buscrit runs on multiple hosts and it is difficult to
        identify the host where a particular transaction was
        executed</li>
        <li>Carol does not (or does not wish to) have access to the
        hosts where Byscrit runs
        </li>
        <li>Buscrit is tested by multiple testers, e.g. Dave and Carol
        and others, simultanesouly so that it is hard to identify and
        track an individual transaction in the log files
        </li>
      </ol>

      <p>Given the above circumstances, let us create a logback
      configuration so that Carol receives an email message at the end
      of every transaction. We will iteratively refine this
      configuration so that Carol will receive an email containing the
      logs of each transaction in isolation and only for the
      transactions she explicitly selects.
      </p>

      <h3>Triggering an email message at the end of each transaction</h3>

      <p>We will be using <code>SMTPAppender</code> to generate emails
      containing logging data. Please refer to the <a
      href="../manual/appenders.html#SMTPAppender">appropriate section
      of the manual</a> to familiarize yourself with
      <code>SMTPAppender</code> and its properties.
      </p> 

      <p>The <a href="demo.html">logback-demo</a> project contains a
      Struts action called <a
      href="http://logback-demo.qos.ch/xref/ch/qos/logback/demo/prime/PrimeAction.html"><code>PrimeAction</code></a>. It
      can factorize integers. Here is the pertinent structure of
      <code>PrimeAction</code>'s code:</p>

      <pre class="prettyprint source">package ch.qos.logback.demo.prime;

import org.apache.struts.action.Action;
...
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class PrimeAction extends Action {

  Logger logger = LoggerFactory.getLogger(PrimeAction.class);
  Marker SMTP_TRIGGER = MarkerFactory.getMarker("SMTP_TRIGGER");

  public ActionForward execute(ActionMapping actionMapping,
                               ActionForm actionForm, HttpServletRequest request,
                               HttpServletResponse response) throws Exception {

    PrimeForm form = (PrimeForm) actionForm;

    Long number = form.getNumber();
    try {
      NumberCruncher nc = new NumberCruncherImpl();
      Long start = System.currentTimeMillis();
      Long[] result = nc.factor(number);
      Long duration = System.currentTimeMillis() - start;
      logger.info("Results computed in {} ms", duration);

      ...
    } finally {
      <b>logger.info(SMTP_TRIGGER, "Prime computation ended");</b>
    }
  }
} </pre>

      <p>In a real world application, a transaction would involve
      systems external to the application, e.g. a database or a
      messaging queue. For the sake of this example, let us consider
      each factorization request as a <em>transaction</em>.  At the
      end of each factorization request, i.e. each transaction, the
      logger of the <code>PrimeAction</code> instance is invoked with
      the SMTP_TRIGGER marker and the message "Prime computation
      ended".  We can capitalize on this logging request to clearly
      identify the end of every transaction in order to trigger an
      outgoing email message.
     </p>

     <p>Here is a configuration file which uses
     <code>JaninoEventEvaluator</code> to trigger an outgoing email
     for logging event marked with SMTP_TRIGGER.
     </p> 

    <pre class="prettyprint
     source">&lt;configuration scan="true" scanPeriod="3 seconds">

  &lt;!-- always a good idea to have an OnConsoleStatusListener -->
  &lt;statusListener class="ch.qos.logback.core.status.OnConsoleStatusListener" />

  &lt;appender name="SMTP" class="ch.qos.logback.classic.net.SMTPAppender">
    &lt;SMTPHost>NAME_OF_SMTP_HOST&lt;/SMTPHost>
    &lt;to>...&lt;/to>                                         
    &lt;from>...&lt;/from>
    &lt;layout class="ch.qos.logback.classic.html.HTMLLayout">
      &lt;pattern>%date%level%logger{24}%msg&lt;/pattern>
    &lt;/layout>
    
    <b>&lt;evaluator class="ch.qos.logback.classic.boolex.JaninoEventEvaluator"></b>
      <b>&lt;expression></b>
        <b>marker != null  &amp;&amp; marker.contains("SMTP_TRIGGER")</b>
      <b>&lt;/expression></b>
    <b>&lt;/evaluator></b>
  &lt;/appender>

  &lt;root level="DEBUG">
    &lt;appender-ref ref="SMTP" /> 
  &lt;/root>

&lt;/configuration></pre>

      
      
      <h3>Transaction isolation</h3>

      <p>
      </p>


  <pre class="prettyprint source">&lt;configuration scan="true" scanPeriod="3 seconds">

  &lt;!-- always a good idea to have an OnConsoleStatusListener -->

  &lt;appender name="SMTP" class="ch.qos.logback.classic.net.SMTPAppender">
    &lt;SMTPHost>NAME_OF_SMTP_HOST&lt;/SMTPHost>
    &lt;To>com&lt;/To>
    &lt;From>&lt;/From>
    &lt;layout class="ch.qos.logback.classic.html.HTMLLayout">
       &lt;pattern>%date%level%logger{24}%msg&lt;/pattern>
    &lt;/layout>

    &lt;discriminator class="ch.qos.logback.classic.sift.MDCBasedDiscriminator">
      &lt;key>uuid&lt;/key>
      &lt;defaultValue>default&lt;/defaultValue>
    &lt;/discriminator>

    &lt;evaluator class="ch.qos.logback.classic.boolex.JaninoEventEvaluator">
      &lt;expression>
        marker != null &amp;&amp; marker.contains("SMTP_TRIGGER") 
      &lt;/expression>
    &lt;/evaluator>

    &lt;discriminator class="ch.qos.logback.classic.sift.MDCBasedDiscriminator">
      &lt;key>uuid&lt;/key>
      &lt;defaultValue>default&lt;/defaultValue>
    &lt;/discriminator>

  &lt;/appender>  </pre>
      

  <h3>Selective triggering &amp; Transaction isolation</h3>
      

  <pre class="prettyprint source">&lt;configuration scan="true" scanPeriod="3 seconds">

  &lt;!-- always a good idea to have an OnConsoleStatusListener -->

  &lt;appender name="SMTP" class="ch.qos.logback.classic.net.SMTPAppender">
    &lt;SMTPHost>NAME_OF_SMTP_HOST&lt;/SMTPHost>
    &lt;To>com&lt;/To>
    &lt;From>&lt;/From>
    &lt;layout class="ch.qos.logback.classic.html.HTMLLayout">
       &lt;pattern>%date%level%logger{24}%msg&lt;/pattern>
    &lt;/layout>

    &lt;discriminator class="ch.qos.logback.classic.sift.MDCBasedDiscriminator">
      &lt;key>uuid&lt;/key>
      &lt;defaultValue>default&lt;/defaultValue>
    &lt;/discriminator>

    &lt;evaluator class="ch.qos.logback.classic.boolex.JaninoEventEvaluator">
      &lt;expression>
        (mdc != null &amp;&amp; mdc.get("txUser") != null &amp;&amp; 
             ((String) mdc.get("txUser")).contains("Mickey") )
        &amp;&amp;
        (marker != null  &amp;&amp; marker.contains("SMTP_TRIGGER") )
      &lt;/expression>
    &lt;/evaluator>

    &lt;discriminator class="ch.qos.logback.classic.sift.MDCBasedDiscriminator">
      &lt;key>uuid&lt;/key>
      &lt;defaultValue>default&lt;/defaultValue>
    &lt;/discriminator>

  &lt;/appender>  </pre>
      <script src="../templates/footer.js" type="text/javascript"></script>	
    </div>
  </body>
</html>
 