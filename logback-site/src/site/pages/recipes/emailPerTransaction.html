<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
    <title>Email per transaction</title>
    <link rel="stylesheet" type="text/css" href="../css/common.css" />
    <link rel="stylesheet" type="text/css" href="../css/screen.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="../css/_print.css" media="print" />
    <link rel="stylesheet" type="text/css" href="../css/prettify.css" media="screen" />

  </head>
  <body onload="prettyPrint()">
    <script type="text/javascript">prefix='../';</script>
    <script type="text/javascript" src="../js/prettify.js"></script>
    <script src="../templates/header.js" type="text/javascript"></script>
    <div id="left">
      <noscript>Please turn on Javascript to view this menu</noscript>
      <script src="../templates/left.js" type="text/javascript"></script>
    </div>
    <div id="content">
      
      <h2>Send an email per transaction but only for certain users</h2>
      
      <p>Let Dave and Tata be software engineers working at a company
      called Fooware.com. As you might have guessed, Fooware.com sells
      foos. Yes, foos. Let <em>Buscrit</em> be a business critical
      back-end system running at Fooware.com. Buscrit is called by a
      number of applications to make business-critical transactions of
      various types.
      </p>

      <p>We would like to allow Tata, a QA-engineer, to access the
      logging data generated by Buscrit as conveniently as
      possible. Tata could access the log files directly on the server
      where Buscrit runs. Let us assume that accessing the log files
      is impractical because one of the following conditions holds
      true:
      </p>

      <ol>
        <li>Buscrit runs on several hosts and it is difficult to
        identify the host where a particular transaction was
        executed</li>
        <li>Tata does not (or does not wish to) have access to the
        hosts where Byscrit runs
        </li>
        <li>Buscrit is tested by half a dozen testers simultanesouly
        so that it is hard to indetify and track an individual
        transaction in the log files
        </li>
      </ol>

      <p>Given the above circumstances, let us create a logback
      configuration so that Tata receives an email message containing
      the logs generated by a single transaction. We will later refine
      this configuration so that Tata will receive an email per transaction
      but only for the transactions she explicitly selects.
      </p>

      <h3>Generating an email message containing the logs of a single
      transaction
      </h3>

      <p>We will be using <code>SMTPAppender</code> to generate emails
      containing logging data. Please refer to the <a
      href="../manual/appenders.html#SMTPAppender">appropriate section
      of the manual</a> to familiarize yourself with
      <code>SMTPAppender</code>.

is described in chapter on
      appenders describes <pre class="prettyprint
      source">&lt;configuration scan="true" scanPeriod="3 seconds">

  &lt;statusListener class="ch.qos.logback.core.status.OnConsoleStatusListener" />

  &lt;appender name="SMTP" class="ch.qos.logback.classic.net.SMTPAppender">
    &lt;SMTPHost>NAME_OF_SMTP_HOST&lt;/SMTPHost>
    &lt;To>...&lt;/To>
    &lt;From>...&lt;/From>
    &lt;layout class="ch.qos.logback.classic.html.HTMLLayout">
      &lt;pattern>%date%level%logger{24}%msg&lt;/pattern>
    &lt;/layout>
    &lt;evaluator class="ch.qos.logback.classic.boolex.JaninoEventEvaluator">
      &lt;expression>
        marker != null  &amp;&amp; marker.contains("SMTP_TRIGGER") 
      &lt;/expression>
    &lt;/evaluator>    
  &lt;/appender>

  &lt;root level="DEBUG">
    &lt;appender-ref ref="SMTP" /> 
  &lt;/root>

&lt;/configuration></pre>
      
  <pre>
 &lt;appender name="SMTP" class="ch.qos.logback.classic.net.SMTPAppender">
    &lt;SMTPHost>NAME_OF_SMTP_HOST&lt;/SMTPHost>
    &lt;To>com&lt;/To>
    &lt;From>&lt;/From>
    &lt;layout class="ch.qos.logback.classic.html.HTMLLayout">
       &lt;pattern>%date%level%logger{24}%msg&lt;/pattern>
    &lt;/layout>

    &lt;discriminator class="ch.qos.logback.classic.sift.MDCBasedDiscriminator">
      &lt;key>uuid&lt;/key>
      &lt;defaultValue>default&lt;/defaultValue>
    &lt;/discriminator>

    &lt;evaluator class="ch.qos.logback.classic.boolex.JaninoEventEvaluator">
      &lt;expression>
        (mdc != null &amp;&amp; mdc.get("txUser") != null &amp;&amp; 
             ((String) mdc.get("txUser")).contains("Mickey") )
        &amp;&amp;
        (marker != null  &amp;&amp; marker.contains("SMTP_TRIGGER") )
      &lt;/expression>
    &lt;/evaluator>

    &lt;discriminator class="ch.qos.logback.classic.sift.MDCBasedDiscriminator">
      &lt;key>uuid&lt;/key>
      &lt;defaultValue>default&lt;/defaultValue>
    &lt;/discriminator>

  &lt;/appender>
  </pre>
      <script src="../templates/footer.js" type="text/javascript"></script>	
    </div>
  </body>
</html>
 